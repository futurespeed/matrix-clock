#include <stdio.h>
#include "simple_gl.h"

static uint16_t GRAM[GL_WIDTH * GL_HEIGHT];
static uint16_t GRAM_TMP[GL_WIDTH * GL_HEIGHT];
uint8_t gl_draw_flag;

static uint8_t FONT_4X7[] = {
    0x3E, 0x41, 0x41, 0x3E, // 0
    0x00, 0x42, 0x7F, 0x40, // 1
    0x61, 0x51, 0x49, 0x46, // 2
    0x41, 0x49, 0x49, 0x36, // 3
    0x0F, 0x08, 0x08, 0x7F, // 4
    0x4F, 0x49, 0x49, 0x31, // 5
    0x3E, 0x49, 0x49, 0x30, // 6
    0x01, 0x71, 0x0D, 0x03, // 7
    0x36, 0x49, 0x49, 0x36, // 8
    0x06, 0x49, 0x49, 0x3E, // 9
    0x00, 0x24, 0x00, 0x00, //:
    0x00, 0x08, 0x08, 0x00, //-
    0x07, 0x05, 0x07, 0x00, //度
    0x3E, 0x41, 0x41, 0x22, // C
};

static uint8_t FONT_8X8[] = {
    0x12, 0x7B, 0x36, 0x41, 0x3F, 0x41, 0x7F, 0x00, /*"初",0*/
    0x08, 0x08, 0x08, 0x08, 0x08, 0x0C, 0x08, 0x00, /*"一",1*/
    0x40, 0x42, 0x42, 0x42, 0x42, 0x62, 0x40, 0x00, /*"二",2*/
    0x40, 0x41, 0x49, 0x49, 0x49, 0x61, 0x40, 0x00, /*"三",3*/
    0x7F, 0x51, 0x4F, 0x41, 0x4F, 0x49, 0x7F, 0x00, /*"四",4*/
    0x40, 0x49, 0x79, 0x4F, 0x49, 0x79, 0x40, 0x00, /*"五",5*/
    0x42, 0x22, 0x1A, 0x03, 0x1A, 0x22, 0x42, 0x00, /*"六",6*/
    0x08, 0x08, 0x3F, 0x48, 0x44, 0x44, 0x64, 0x00, /*"七",7*/
    0x40, 0x30, 0x0F, 0x00, 0x0F, 0x30, 0x40, 0x00, /*"八",8*/
    0x42, 0x32, 0x0F, 0x02, 0x7E, 0x40, 0x60, 0x00, /*"九",9*/
    0x04, 0x04, 0x04, 0x7F, 0x04, 0x04, 0x04, 0x00, /*"十",10*/
    0x04, 0x7F, 0x44, 0x44, 0x44, 0x7F, 0x04, 0x00, /*"廿",11*/
    0x24, 0x3B, 0x2A, 0x7E, 0x2A, 0x2A, 0x22, 0x00, /*"年",12*/
    0x40, 0x20, 0x1F, 0x15, 0x15, 0x55, 0x7F, 0x00, /*"月",13*/
    0x00, 0x7F, 0x49, 0x49, 0x49, 0x49, 0x7F, 0x00, /*"日",14*/
};

static uint8_t FONT_12X12[] = {
    0x84, 0x00, 0x45, 0x00, 0xF6, 0x0F, 0x4C, 0x00, 0xA0, 0x08, 0x02, 0x06,
    0xFE, 0x01, 0x02, 0x00, 0x02, 0x08, 0x02, 0x08, 0xFE, 0x07, 0x00, 0x00, /*"初",0*/
    0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00,
    0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x00, 0x00, /*"一",1*/
    0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00, /*"二",2*/
    0x00, 0x08, 0x02, 0x08, 0x42, 0x08, 0x42, 0x08, 0x42, 0x08, 0x42, 0x08,
    0x42, 0x08, 0x42, 0x08, 0x42, 0x08, 0x02, 0x08, 0x00, 0x08, 0x00, 0x00, /*"三",3*/
    0x00, 0x00, 0xFE, 0x0F, 0x02, 0x05, 0x82, 0x04, 0x7E, 0x04, 0x02, 0x04,
    0x02, 0x04, 0x7E, 0x04, 0x82, 0x04, 0x82, 0x04, 0xFE, 0x0F, 0x00, 0x00, /*"四",4*/
    0x02, 0x08, 0x22, 0x08, 0x22, 0x0E, 0xE2, 0x09, 0x3E, 0x08, 0x22, 0x08,
    0x22, 0x08, 0x22, 0x08, 0xE2, 0x0F, 0x02, 0x08, 0x00, 0x08, 0x00, 0x00, /*"五",5*/
    0x10, 0x08, 0x10, 0x04, 0x10, 0x03, 0xD0, 0x00, 0x11, 0x00, 0x16, 0x00,
    0x10, 0x00, 0x50, 0x00, 0x90, 0x00, 0x10, 0x03, 0x10, 0x0C, 0x00, 0x00, /*"六",6*/
    0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0xFF, 0x07, 0x10, 0x08,
    0x10, 0x08, 0x10, 0x08, 0x10, 0x08, 0x10, 0x08, 0x10, 0x0E, 0x00, 0x00, /*"七",7*/
    0x00, 0x08, 0x00, 0x04, 0x00, 0x03, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x7F, 0x00, 0x80, 0x01, 0x00, 0x06, 0x00, 0x08, 0x00, 0x00, /*"八",8*/
    0x08, 0x08, 0x08, 0x04, 0x08, 0x03, 0xFF, 0x00, 0x08, 0x00, 0x08, 0x00,
    0x08, 0x00, 0xF8, 0x07, 0x00, 0x08, 0x00, 0x08, 0x00, 0x0E, 0x00, 0x00, /*"九",9*/
    0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0xFF, 0x0F,
    0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x00, 0x00, /*"十",10*/
    0x10, 0x00, 0x10, 0x00, 0xFF, 0x0F, 0x10, 0x04, 0x10, 0x04, 0x10, 0x04,
    0x10, 0x04, 0x10, 0x04, 0xFF, 0x0F, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00, /*"廿",11*/
    0x10, 0x01, 0x08, 0x01, 0xE7, 0x01, 0x24, 0x01, 0x24, 0x01, 0x24, 0x01,
    0xFC, 0x0F, 0x24, 0x01, 0x24, 0x01, 0x24, 0x01, 0x04, 0x01, 0x00, 0x00, /*"年",12*/
    0x00, 0x08, 0x00, 0x06, 0xFE, 0x01, 0x92, 0x00, 0x92, 0x00, 0x92, 0x00,
    0x92, 0x00, 0x92, 0x08, 0x92, 0x08, 0xFE, 0x0F, 0x00, 0x00, 0x00, 0x00, /*"月",13*/
    0x00, 0x00, 0xFE, 0x0F, 0x22, 0x04, 0x22, 0x04, 0x22, 0x04, 0x22, 0x04,
    0x22, 0x04, 0x22, 0x04, 0x22, 0x04, 0xFE, 0x0F, 0x00, 0x00, 0x00, 0x00, /*"日",14*/
};

uint16_t img_sun[] = {
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xF3E0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xF3E0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0xF3E0,0xFBE0,0x0000,0x0000,0xF3E0,0x0000,0x0000,0xFBE0,0xF3E0,0x0000,0x0000,
0x0000,0x0000,0xFBE0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xFBE0,0x0000,0x0000,
0x0000,0x0000,0x0000,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0x0000,0x0000,0x0000,
0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,
0x0000,0x0000,0x0000,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0x0000,0x0000,0x0000,
0x0000,0x0000,0xFBE0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xF3E0,0xFBE0,0x0000,0x0000,
0x0000,0x0000,0xF3E0,0xFBE0,0x0000,0x0000,0xF3E0,0x0000,0x0000,0xFBE0,0xF3E0,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xF3E0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xF3E0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
};//13x13

uint16_t img_rain[] = {
0x0000,0x0000,0x0000,0x0000,0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,
0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,
0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,
0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,
0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x0000,
0x0000,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x0000,
0x0000,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x03FF,0x03FF,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
};//15x12

uint16_t img_cloud[] = {
0x0000,0x0000,0x0000,0x0000,0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,0x0000,0x0000,0x0000,
0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,
0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,
0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,
0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,
0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,
};//14x7

uint16_t img_snow[] = {
0x0000,0x0000,0x0000,0x0000,0xFBFF,0x0000,0x0000,0x0000,0x0000,
0x0000,0xFBFF,0xFBFF,0x0000,0xFBFF,0x0000,0xFBFF,0xFBFF,0x0000,
0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,
0x0000,0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,0x0000,
0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,
0x0000,0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,0x0000,
0x0000,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0xFBFF,0x0000,
0x0000,0xFBFF,0xFBFF,0x0000,0xFBFF,0x0000,0xFBFF,0xFBFF,0x0000,
0x0000,0x0000,0x0000,0x0000,0xFBFF,0x0000,0x0000,0x0000,0x0000,
};//9x9

gl_font_t font_4x7 = {4, 7, FONT_4X7};
gl_font_t font_8x8 = {8, 8, FONT_8X8};
gl_font_t font_12x12 = {12, 12, FONT_12X12};

gl_img_t gl_img_sun = {13,13,img_sun};
gl_img_t gl_img_rain = {15,12,img_rain};
gl_img_t gl_img_cloud = {14,7,img_cloud};
gl_img_t gl_img_snow = {9,9,img_snow};

uint16_t *_get_gram();

uint16_t *gl_getGRAM()
{
    return GRAM;
}

void gl_draw_begin()
{
    gl_draw_flag = 1;
}
void gl_draw_end()
{
    uint8_t i, j;
    for (i = 0; i < GL_HEIGHT; i++)
    {
        for (j = 0; j < GL_WIDTH; j++)
        {
            GRAM[i * GL_WIDTH + j] = GRAM_TMP[i * GL_WIDTH + j];
        }
    }
    gl_draw_flag = 0;
}

void gl_fill(uint16_t color)
{
    uint16_t *gram = _get_gram();
    uint8_t i, j;
    for (i = 0; i < GL_HEIGHT; i++)
    {
        for (j = 0; j < GL_WIDTH; j++)
        {
            gram[i * GL_WIDTH + j] = color;
        }
    }
}

void gl_draw_point(uint16_t x, uint16_t y, uint16_t color)
{
    uint16_t *gram = _get_gram();
    gram[y * GL_WIDTH + x] = color;
}

void gl_draw_line(uint16_t x1, uint16_t y1, uint16_t x2, uint16_t y2, uint16_t color)
{
    // Bresenham算法
    int16_t dx = x2 - x1;
    int16_t dy = y2 - y1;
    int16_t ux = ((dx > 0) << 1) - 1; // x的增量方向，取1或-1
    int16_t uy = ((dy > 0) << 1) - 1; // y的增量方向，取1或-1
    int16_t x = x1, y = y1, eps;      // eps为累加误差

    eps = 0;
    // dx = abs(dx);
    // dy = abs(dy);
    dx = (dx > 0) ? (dx) : (-dx);
    dy = (dy > 0) ? (dy) : (-dy);

    if (dx > dy)
    {
        for (x = x1; x != x2 + ux; x += ux)
        {
            gl_draw_point(x, y, color);
            eps += dy;
            if ((eps << 1) >= dx)
            {
                y += uy;
                eps -= dx;
            }
        }
    }
    else
    {
        for (y = y1; y != y2 + uy; y += uy)
        {
            gl_draw_point(x, y, color);
            eps += dx;
            if ((eps << 1) >= dy)
            {
                x += ux;
                eps -= dy;
            }
        }
    }
}

void gl_draw_rectangle(uint16_t x1, uint16_t y1, uint16_t x2, uint16_t y2, uint16_t color, uint8_t fill)
{
    int16_t x, y;
    if (fill)
    {
        for (y = y1; y < y2 + 1; y++)
        {
            for (x = x1; x < x2 + 1; x++)
            {
                gl_draw_point(x, y, color);
            }
        }
        return;
    }

    gl_draw_line(x1, y1, x2, y1, color);
    gl_draw_line(x1, y2, x2, y2, color);
    gl_draw_line(x1, y1, x1, y2, color);
    gl_draw_line(x2, y1, x2, y2, color);
}

void gl_draw_font(gl_font_t font, uint16_t index, uint16_t x, uint16_t y, uint16_t front_color, uint16_t bg_color, uint8_t scale)
{
    uint16_t *gram = _get_gram();
    uint8_t *font_data = font.data;
    uint8_t font_width = font.width, font_heigh = font.height;
    uint8_t i, j, si, sj, fill;
    for (i = 0; i < font_heigh; i++)
    {
        for (j = 0; j < font_width; j++)
        {
            fill = font_data[j + font_width * index] >> i & 0x1;
            if (scale <= 1)
            {
                gram[(i + y) * GL_WIDTH + j + x] = fill ? front_color : bg_color;
            }
            else
            {
                for (si = 0; si < scale; si++)
                {
                    for (sj = 0; sj < scale; sj++)
                    {
                        gram[(i * scale + si + y) * GL_WIDTH + j * scale + sj + x] = fill ? front_color : bg_color;
                    }
                }
            }
        }
    }
}

void gl_draw_image(gl_img_t gl_img, uint16_t x, uint16_t y, uint8_t transparent, uint16_t transparent_color)
{
    uint16_t *gram = _get_gram();
    uint16_t i, j;
    uint16_t *p_img = gl_img.data;
    for (j = 0; j < gl_img.height; j++)
    {
        for (i = 0; i < gl_img.width; i++)
        {
            if(!transparent || transparent_color != *p_img)
            {
                gram[(y + j) * GL_WIDTH + x + i] = *p_img;
            }
            p_img++;
        }
    }
}

uint16_t *_get_gram()
{
    return gl_draw_flag ? GRAM_TMP : GRAM;
}

void gl_print()
{
    // 模拟显示
    uint16_t i, j;
    uint16_t color;
    for (i = 0; i < GL_HEIGHT; i++)
    {
        for (j = 0; j < GL_WIDTH; j++)
        {
            color = GRAM[i * GL_WIDTH + j];
            if (color)
                printf(" %d", color % 8);
            else
                printf(" .");
        }
        printf("\r\n");
    }

    // // python数组
    // uint16_t i, j;
    // uint16_t color;
    // uint32_t d = 10000;
    // uint32_t f = 0xff*d/0x1f;
    // printf("[");
    // for (i = 0; i < GL_HEIGHT; i++)
    // {
    //     if(i>0) printf(",");
    //     printf("[");
    //     for (j = 0; j < GL_WIDTH; j++)
    //     {
    //         if(j>0) printf(",");
    //         color = GRAM[i * GL_WIDTH + j];
    //         printf(" [%d,%d,%d]", (color>>0&0x1f)*f/d,(color>>5&0x1f)*f/d,(color>>11&0x1f)*f/d);//bgr
    //     }
    //     printf("]");
    // }
    // printf("]\r\n");

    // // C数组
    // uint16_t i, j;
    // uint16_t color;
    // printf("#include <stdint.h>\r\n\r\nuint16_t img[] = {");
    // for (i = 0; i < GL_HEIGHT; i++)
    // {
    //     if(i>0) printf(",");
    //     for (j = 0; j < GL_WIDTH; j++)
    //     {
    //         if(j>0) printf(",");
    //         color = GRAM[i * GL_WIDTH + j];
    //         printf(" 0x%X", color);
    //     }
    //     printf("\r\n");
    // }
    // printf("};\r\n");
}